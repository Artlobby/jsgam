function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var i=require("pixi.js");require("pixi-layers");var e=t(require("localforage"));require("pixi-sound");var s=t(require("walkable")),n=require("polyk");require("k8w-pixi-tween");var a=t(require("dragonbones-pixi")),o=function(t){function i(){t.call(this),this.game=null,this.onLoad.add(this.update.bind(this)),this.onError.add(this.error.bind(this))}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.addJSON=function(t){var i,e=t.length;for(i=0;i<e;i++){var s=t[i].slice(t[i].lastIndexOf("/")+1,t[i].lastIndexOf("."));this.add(s,t[i])}},i.prototype.addFiles=function(t){var i,e=t.length;for(i=0;i<e;i++){if(t[i].data.Settings&&(this.game.settings=t[i].data.Settings),t[i].data.Scenes&&(this.game.data.scenes=t[i].data.Scenes),t[i].data.Cutscenes&&(this.game.data.cutscenes=t[i].data.Cutscenes),t[i].data.Objects&&(this.game.data.objects=t[i].data.Objects),t[i].data.Dialogues&&(this.game.data.dialogues=t[i].data.Dialogues),t[i].data.Puzzles&&(this.game.data.puzzles=t[i].data.Puzzles),t[i].data.Credits&&(this.game.data.credits=t[i].data.Credits),t[i].data.Texts&&(this.game.data.texts=t[i].data.Texts),t[i].data.Sounds)for(var s=t[i].data.Sounds,n=0;n<s.length;n++){var a=s[n].Src;null!==a&&this.add(s[n].Name,a)}if(t[i].data.Vids){this.fixVidLoad();for(var o=t[i].data.Vids,h=0;h<o.length;h++){var r=o[h].Src;null!==r&&this.add(o[h].Name,r)}}if(t[i].data.Animations)for(var c=t[i].data.Animations,p=0;p<c.length;p++){var d=c[p].Src;null!==d&&this.add(c[p].Name,d)}if(t[i].data.Backgrounds)for(var g=t[i].data.Animations,u=0;u<g.length;u++){var l=g[u].Src;null!==l&&this.add(g[u].Name,l)}if(t[i].data.Player&&(this.add("playerTex",t[i].data.Player.Texture).add("playerJson",t[i].data.Player.Json).add("playerSkeleton",t[i].data.Player.Skeleton),this.game.data.player=t[i].data.Player),t[i].data.Characters){for(var m=t[i].data.Characters,f=0;f<m.length;f++)this.add(m[f].Name+"Tex",m[f].Texture).add(m[f].Name+"Json",m[f].Json).add(m[f].Name+"Skeleton",m[f].Skeleton);this.game.data.npc=t[i].data.Characters}}},i.prototype.fixVidLoad=function(){PIXI.sound.utils.extensions.splice(PIXI.sound.utils.extensions.indexOf("mp4"),1),PIXI.loaders.Resource.setExtensionXhrType("mp4",void 0),PIXI.loaders.Resource.setExtensionLoadType("mp4",PIXI.loaders.Resource.LOAD_TYPE.VIDEO)},i.prototype.update=function(){var t=Math.floor(this.progress);this.game.progressBar.width=this.game.width/100*t},i.prototype.error=function(t){console.log(t)},i}(PIXI.loaders.Loader),h=function(t){this.game=t};h.prototype.save=function(){var t=[];Object.values(this.game.puzzles).forEach(function(i){i.solved&&!t.includes(i.config.Name)&&t.push(i.config.Name)});var i=[];Object.values(this.game.dialogues).forEach(function(t){Object.values(t.branches).forEach(function(e){e.Choices.forEach(function(s,n){s.disabled&&i.push({Dialogue:t.config.Name,Branch:e.Name,Index:n})})})});var s=[];Object.values(this.game.cutscenes).forEach(function(t){t.played&&s.push(t.config.Name)}),this.progress={language:this.game.activeLanguage,latestScene:this.game.activeScene.config.Name,playerPos:[this.game.player.sprite.x,this.game.player.sprite.y],inventory:this.game.inventory.objects,puzzles:t,dialogues:i,cutscenes:s},e.setItem("JSGAM_Storage",this.progress)},h.prototype.load=function(){var t=this.game;this.progress.inventory.forEach(function(i){t.inventory.add(i);var e=i;Object.values(t.scenes).forEach(function(t){if(void 0!==t.config.Objects&&t.config.Objects.includes(e)){var i=t.config.Objects.indexOf(e);t.config.Objects.splice(i,1)}})}),this.progress.dialogues.forEach(function(i){t.dialogues[i.Dialogue].branches[i.Branch].Choices[i.Index].disabled=!0}),this.progress.cutscenes.forEach(function(i){t.cutscenes[i].played=!0}),this.game.silentMode=!0,this.progress.puzzles.forEach(function(i){t.puzzles[i].resolve()}),this.game.silentMode=!1},h.prototype.delete=function(){e.clear()},h.prototype.check=function(){var t=this;e.getItem("JSGAM_Storage").then(function(i){null!==i&&(t.progress=i,t.game.activeLanguage=i.language,t.game.scenes.Title.changeLanguage(),t.game.scenes.Title.states.MainMenu.enable("Continue"))}).catch(function(t){console.log(t)})};var r=function(){this.container=new PIXI.Container,this.game=null};r.prototype.setup=function(t){this.background=new PIXI.Sprite(PIXI.Texture.from(t.Background)),this.background.anchor.set(0),this.container.addChild(this.background),this.music=t.Music,this.config=t},r.prototype.update=function(t){},r.prototype.hide=function(){this.container.visible=!1},r.prototype.show=function(){this.container.visible=!0};var c=function(t){function i(i,e){t.call(this,i,e),this.interactive=!0,this.buttonMode=!0}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i}(PIXI.extras.BitmapText),p=function(t){function i(i,e){t.call(this,i,e)}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i}(PIXI.extras.BitmapText),d=function(t){this.container=new PIXI.Container,this.hide(),this.game=t,this.option=[];for(var i=0;i<3;i++)this.option[i]=new c("Option",this.game.settings.Text.ButtonStyle),this.option[i].game=this.game,this.option[i].on("pointertap",this.onTap.bind(this.option[i])),this.option[i].index=i,this.container.addChild(this.option[i]),i>0&&(this.option[i].y=this.option[i-1].y+this.option[i-1].height)};d.prototype.show=function(){this.sort(),this.container.visible=!0},d.prototype.hide=function(){this.container.visible=!1},d.prototype.onTap=function(){var t=this.game.activeDialogue.currentBranch.Choices;1==this.alpha&&(this.game.activeDialogue.choice=this.index,0==t[this.index].Repeat&&(t[this.index].disabled=!0),this.game.activeDialogue.next())},d.prototype.get=function(){this.clear();for(var t=this.game.activeDialogue.currentBranch.Choices,i=0;i<t.length;i++)this.option[i].alpha=t[i].disabled?.5:1,this.option[i].visible=!0,this.option[i].text=t[i].Text[this.game.activeLanguage];this.show()},d.prototype.clear=function(){for(var t=0;t<this.option.length;t++)this.option[t].visible=!1},d.prototype.sort=function(){for(var t=0;t<this.option.length;t++)this.option[t].anchor.set(.5,0),this.option[t].x=this.game.width/2;(this.container.width>this.container.parent.width||this.container.height>this.container.parent.height)&&this.scale()},d.prototype.scale=function(){var t=Math.min(this.container.parent.width/this.container.width,this.container.parent.height/this.container.height);this.container.scale.set(.95*t),this.container.x=this.container.width};var g=function(){this.container=new PIXI.Container,this.Background=null,this.Text=null,this.container.visible=!1};g.prototype.build=function(){this.container.parentLayer=this.game.layerUI,this.Background=new PIXI.Sprite(PIXI.Texture.WHITE);var t=4;void 0!==this.game.settings.Text.Size&&("fourth"===this.game.settings.Text.Size?t=4:"half"===this.game.settings.Text.Size&&(t=2)),this.Background.width=this.game.width,this.Background.height=this.game.height/t,this.Background.tint="black",this.Background.alpha=.5,this.Text=new c("",this.game.settings.Text.Style),this.Text.anchor.set(.5,0),this.Text.x=this.game.width/2,this.Text.y=0,this.Text.on("pointertap",this.skip.bind(this)),this.Choices=new d(this.game),this.container.addChild(this.Background),this.container.addChild(this.Text),this.container.addChild(this.Choices.container),void 0!==this.game.settings.Text.Position&&this.setPosition(this.game.settings.Text.Position)},g.prototype.show=function(){this.Text.visible=!0,this.container.visible=!0},g.prototype.hide=function(){this.container.visible=!1},g.prototype.end=function(){null!==this.game.activeDialogue?(this.talker.shutup(),null!==this.game.activeDialogue.choice?this.game.activeDialogue.answer():(this.Text.visible=!1,this.Choices.get())):(this.setText(""),this.hide(),this.talker.shutup(),this.game.player.stop())},g.prototype.skip=function(){this.end(),this.talker&&clearTimeout(this.talker.timeoutID)},g.prototype.setPosition=function(t){"top"===t?(this.container.x=0,this.container.y=0):"bottom"===t&&(this.container.x=0,this.container.y=this.game.height-this.container.height)},g.prototype.setText=function(t){this.Text.text=t,(this.Text.width>this.container.width||this.Text.height>this.container.height)&&this.adjustText()},g.prototype.adjustText=function(){var t=Math.min(this.container.width/this.Text.width,this.container.height/this.Text.height);this.container.scale.set(.95*t)},g.prototype.countWords=function(t){return t.split(" ").length},g.prototype.timeOut=function(){var t;return(t=void 0!==this.game.settings.Text.Speed?this.game.settings.Text.Speed:this.countWords(this.Text.text)/3)<1&&(t=1),1e3*t},g.prototype.setColor=function(t){this.Text.tint=t};var u=function(){this.container=new PIXI.Container,this.game=null,this.buttons={}};u.prototype.addButton=function(t,i){this.buttons[t]=new c(i[this.game.activeLanguage],this.game.settings.Text.ButtonStyle),this.container.addChild(this.buttons[t])},u.prototype.modify=function(t,i){this.buttons[t].text=i[this.game.activeLanguage]},u.prototype.disable=function(t){this.buttons[t].alpha=.5,this.buttons[t].interactive=!1},u.prototype.enable=function(t){this.buttons[t].alpha=1,this.buttons[t].interactive=!0},u.prototype.sort=function(){var t,i=Object.values(this.buttons),e=i.length;for(i[0].y=0,t=1;t<e;t++)i[t].y=i[t-1].y+1.5*i[t-1].height,i[t].x=this.container.width/2-i[t].width/2;this.center()},u.prototype.resize=function(){var t=Math.min(this.game.width/this.container.width,this.game.height/this.container.height);this.container.scale.set(.95*t)},u.prototype.hide=function(){this.container.visible=!1},u.prototype.show=function(){this.container.visible=!0},u.prototype.center=function(){this.container.x=this.game.width/2,this.container.y=this.game.height/2,this.container.pivot.x=this.container.width/2,this.container.pivot.y=this.container.height/2};var l=function(t){function i(){t.apply(this,arguments)}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.create=function(){var t=this.game.data.texts;this.addButton("New",t.NewGame),this.addButton("Continue",t.Continue),this.addButton("Options",t.Options),this.addButton("Help",t.Help),this.addButton("Credits",t.Credits),this.disable("Continue"),this.sort()},i.prototype.changeLanguage=function(){this.modify("New",this.game.data.texts.NewGame),this.modify("Continue",this.game.data.texts.Continue),this.modify("Options",this.game.data.texts.Options),this.modify("Help",this.game.data.texts.Help),this.modify("Credits",this.game.data.texts.Credits),this.sort()},i}(u),m=function(t){function i(){t.apply(this,arguments)}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.create=function(){this.container.visible=!1;for(var t=this.game.settings.Languages,i=0;i<t.length;i++)this.addLanguage(t[i]),this.buttons[t[i]].on("pointerup",this.setLanguage);Object.values(this.buttons)[this.game.activeLanguage].tint=16711680,this.addButton("Back",this.game.data.texts.Back),this.sort()},i.prototype.addLanguage=function(t){this.buttons[t]=new c(t,this.game.settings.Text.ButtonStyle),this.buttons[t].father=this,this.container.addChild(this.buttons[t])},i.prototype.setLanguage=function(){this.father.change(this.text)},i.prototype.change=function(t){var i=this.game.settings.Languages;this.buttons[i[this.game.activeLanguage]].tint=16777215,this.game.activeLanguage=this.game.settings.Languages.indexOf(t),this.buttons[i[this.game.activeLanguage]].tint=16711680,this.modify("Back",this.game.data.texts.Back),this.sort()},i}(u),f=function(){this.container=new PIXI.Container,this.container.visible=!1,this.container.interactive=!0,this.container.buttonMode=!0};f.prototype.create=function(){this.background=new PIXI.Sprite(PIXI.Texture.from(this.game.settings.Help[this.game.activeLanguage])),this.container.addChild(this.background),this.center(),this.container.on("pointerup",this.mainMenu.bind(this))},f.prototype.show=function(){this.container.visible=!0},f.prototype.hide=function(){this.container.visible=!1},f.prototype.changeLanguage=function(){this.background.texture=PIXI.Texture.from(this.game.settings.Help[this.game.activeLanguage]),this.center()},f.prototype.center=function(){this.container.x=this.game.width/2,this.container.y=this.game.height/2,this.container.pivot.x=this.container.width/2,this.container.pivot.y=this.container.height/2},f.prototype.mainMenu=function(){this.game.scenes.Title.mainMenu()};var y=function(){this.container=new PIXI.Container,this.container.visible=!1,this.container.interactive=!0,this.container.buttonMode=!0};y.prototype.create=function(){var t=this.game.data.credits;void 0!==t.Background&&(this.background=new PIXI.Sprite(PIXI.Texture.from(t.Background))),this.buildText(),this.structuredText=new PIXI.extras.BitmapText(this.text,t.Style),this.container.addChild(this.structuredText),this.container.x=this.game.width/2,this.container.pivot.x=this.container.width/2,this.container.y=this.game.height,this.tween=PIXI.tweenManager.createTween(this.container),this.tween.from({y:this.game.height}).to({y:0-this.container.height}),this.tween.time=2e4,this.tween.expire=!0,this.tween.delay=500,this.tween.on("end",this.mainMenu.bind(this)),this.container.on("pointerup",this.mainMenu.bind(this))},y.prototype.show=function(){this.container.visible=!0,this.tween.start()},y.prototype.hide=function(){this.tween.stop().reset(),this.container.visible=!1},y.prototype.buildText=function(){var t,i=this.game.data.credits;for(this.text="",t=0;t<i.Lines.length;t++){this.text+=i.Lines[t].Title[this.game.activeLanguage],this.text+="\n";var e=void 0;for(e=0;e<i.Lines[t].Text.length;e++)this.text+=i.Lines[t].Text[e],this.text+="\n";this.text+="\n"}},y.prototype.update=function(){PIXI.tweenManager.update()},y.prototype.changeLanguage=function(){this.buildText(),this.structuredText.text=this.text},y.prototype.mainMenu=function(){this.game.scenes.Title.mainMenu()};var v=function(t){function i(){t.apply(this,arguments)}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.create=function(){this.hide();var t=this.game.data.texts;this.addText("Warning",t.Warning),this.addButton("Yes",t.Yes),this.addButton("No",t.No),this.sort()},i.prototype.changeLanguage=function(){this.text.text=this.game.data.texts.Warning[this.game.activeLanguage],this.modify("Yes",this.game.data.texts.Yes),this.modify("No",this.game.data.texts.No),this.sort()},i.prototype.sort=function(){this.text.y=0,this.text.x=this.game.width/2-this.text.width/2,this.buttons.Yes.y=1.5*this.text.height,this.buttons.Yes.x=this.buttons.Yes.width,this.buttons.No.y=1.5*this.text.height,this.buttons.No.x=this.game.width-2*this.buttons.No.width,this.container.y=this.game.height/2-this.container.height/2},i.prototype.mainMenu=function(){this.game.scenes.Title.mainMenu()},i.prototype.addText=function(t,i){this.text=new p(i[this.game.activeLanguage],this.game.settings.Text.ButtonStyle),this.container.addChild(this.text)},i}(u),b=function(t){function i(){t.apply(this,arguments)}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.build=function(){this.states={},this.addState("MainMenu",new l),this.addState("Options",new m),this.addState("Credits",new y),this.addState("Help",new f),this.addState("Warning",new v),this.addAction("MainMenu","Options",this.showOptions.bind(this)),this.addAction("MainMenu","Help",this.showHelp.bind(this)),this.addAction("MainMenu","Credits",this.showCredits.bind(this)),this.addAction("MainMenu","New",this.checkAdventure.bind(this)),this.addAction("MainMenu","Continue",this.loadAdventure.bind(this)),this.addAction("Warning","Yes",this.newAdventure.bind(this)),this.addAction("Warning","No",this.mainMenu.bind(this)),this.addAction("Options","Back",this.mainMenu.bind(this))},i.prototype.addAction=function(t,i,e){this.states[t].buttons[i].on("pointerup",e)},i.prototype.addState=function(t,i,e){this.states[t]=i,i.game=this.game,i.create(),this.container.addChild(this.states[t].container)},i.prototype.showOptions=function(){this.states.MainMenu.hide(),this.states.Options.show()},i.prototype.showHelp=function(){this.states.MainMenu.hide(),this.states.Help.show()},i.prototype.showCredits=function(){this.states.MainMenu.hide(),this.states.Credits.show(),this.game.activeState=this.states.Credits},i.prototype.mainMenu=function(){this.game.activeState=null,this.states.Credits.hide(),this.states.Options.hide(),this.states.Help.hide(),this.states.Warning.hide(),this.changeLanguage(),this.states.MainMenu.show()},i.prototype.changeLanguage=function(){this.states.MainMenu.changeLanguage(),this.states.Credits.changeLanguage(),this.states.Help.changeLanguage(),this.states.Warning.changeLanguage()},i.prototype.warning=function(){this.states.MainMenu.hide(),this.states.Warning.show()},i.prototype.checkAdventure=function(){void 0!==this.game.storage.progress?this.warning():this.newAdventure()},i.prototype.newAdventure=function(){this.game.storage.delete(),this.game.setScene(this.game.settings.FirstScene),this.game.start()},i.prototype.loadAdventure=function(){this.game.storage.load(),this.game.setScene(this.game.storage.progress.latestScene),this.game.start()},i}(r),x=function(t){function i(){t.apply(this,arguments)}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.build=function(){if(this.background.parentLayer=this.game.layer,this.background.interactive=!0,this.background.buttonMode=!0,this.background.on("pointertap",this.getPosition.bind(this)),this.walkable=new s(this.game.width,this.game.height),void 0!==this.config.WalkArea&&this.walkable.addPolygon(this.config.WalkArea),void 0!==this.config.Obstacles){var t=Object.values(this.config.Obstacles);this.config.Obstacles=t;for(var i=0;i<this.config.Obstacles.length;i++)this.walkable.addPolygon(this.config.Obstacles[i])}var e=this.config.Objects;if(e)for(var n=0;n<e.length;n++)void 0!==this.game.objects[e[n]]?this.container.addChild(this.game.objects[e[n]].sprite):console.log("Error:Game object "+e[n]+" not found");var a=this.config.Characters;if(a)for(var o=0;o<a.length;o++)void 0!==this.game.npcs[a[o]]?this.container.addChild(this.game.npcs[a[o]].sprite):console.log("Error:Game character "+a[o]+" not found")},i.prototype.getPosition=function(t){var i=t.data.getLocalPosition(this.game.app.stage);this.game.player.lock||null!==this.game.activeObject||this.game.player.move(i)},i.prototype.getPath=function(t,i,e,s){return this.walkable.findPath(t,i,e,s,0)},i}(r),w=function(){this.container=new PIXI.Container,this.sequenceIndex=0,this.played=!1};function I(t,i){var e=t.getBounds(),s=i.getBounds();return e.x+e.width>s.x&&e.x<s.x+s.width&&e.y+e.height>s.y&&e.y<s.y+s.height}function S(t,i){var e;return null!=t&&null!=i&&(e=t.hitArea?n.ContainsPoint(t.hitArea.points,i.x,i.y):i.hitArea?n.ContainsPoint(i.hitArea.points,t.x,t.y):I(t,i)),e}w.prototype.build=function(){if(this.config.Video)this.videoData=this.game.files.resources[this.config.Video].data,this.videoEnds=this.end.bind(this),this.videoData.addEventListener("ended",this.videoEnds);else if(this.config.Sequence){this.image=new PIXI.Sprite(PIXI.Texture.from(this.config.Sequence[this.sequenceIndex].Image));var t=Math.min(this.game.width/this.image.width,this.game.height/this.image.height);this.image.scale.set(t/2),this.container.interactive=!0,this.container.buttonMode=!0,this.container.on("pointertap",this.next.bind(this)),this.container.addChild(this.image),this.field=new PIXI.Text(this.config.Sequence[this.sequenceIndex].Text[this.game.activeLanguage],this.game.settings.Text.Style),this.field.anchor.set(.5,0),this.field.x=this.image.width/2,this.field.y=this.image.height+this.field.height/2,this.container.addChild(this.field),this.container.x=(this.game.width-this.image.width)/2,this.container.y=(this.game.height-this.image.height)/2}},w.prototype.show=function(){if(this.config.Video){var t=PIXI.Texture.from(this.videoData);this.videoSprite=new PIXI.Sprite(t),this.videoSprite.width=this.game.width,this.videoSprite.height=this.game.height,this.videoSprite.interactive=!0,this.videoSprite.buttonMode=!0,this.videoSprite.on("pointertap",this.end.bind(this)),this.container.addChild(this.videoSprite)}else this.config.Sequence&&(this.timeoutID=setTimeout(this.next.bind(this),1e3*this.config.Sequence[this.sequenceIndex].Time));this.game.app.stage.addChild(this.container),this.game.activeScene.hide(),this.game.inventory.hideIcon(),this.game.player.hide()},w.prototype.hide=function(){this.container.parent.removeChild(this.container)},w.prototype.next=function(){this.timeoutID&&clearTimeout(this.timeoutID),this.sequenceIndex<this.config.Sequence.length-1?(this.sequenceIndex+=1,this.field.text=this.config.Sequence[this.sequenceIndex].Text[this.game.activeLanguage],this.image.texture=PIXI.Texture.from(this.config.Sequence[this.sequenceIndex].Image),this.timeoutID=setTimeout(this.next.bind(this),1e3*this.config.Sequence[this.sequenceIndex].Time)):this.end()},w.prototype.end=function(){this.timeoutID&&clearTimeout(this.timeoutID),this.videoData&&(this.videoData.pause(),this.videoData.removeEventListener("ended",this.videoEnds)),this.hide(),this.played=!0,this.game.activeScene.show(),this.game.inventory.showIcon(),this.game.player.show()};var P=function(){this.sprite=null,this.game=null,this.action=null};P.prototype.build=function(){if(this.config.Texture)this.sprite=new PIXI.Sprite.from(PIXI.Texture.from(this.config.Texture));else if(this.config.Area)this.sprite=new PIXI.Sprite.from(PIXI.Texture.EMPTY),this.sprite.hitArea=new PIXI.Polygon(this.config.Area);else if(this.config.Animation){for(var t=this.game.files.resources[this.config.Animation.Name].spritesheet,i=[],e=0;e<t._frameKeys.length;e++)i.push(PIXI.Texture.from(t._frameKeys[e]));this.sprite=new PIXI.extras.AnimatedSprite(i),this.animationSpeed=this.config.Animation.Speed,this.play()}this.config.Position&&(this.sprite.x=this.config.Position[0],this.sprite.y=this.config.Position[1]),this.config.Size&&this.sprite.scale.set(this.config.Size),this.config.Area||this.sprite.anchor.set(.5,1),this.sprite.parentLayer="Front"==this.config.Layer?this.game.layeronTop:this.game.layer,this.config.Door&&(this.door=!0,this.newScene=this.config.Door.To,this.playerPos=this.config.Door.Player),this.sprite.interactive=!0,this.sprite.buttonMode=!0,void 0!==this.config.Area?this.sprite.on("pointerdown",this.touchArea.bind(this)).on("pointerup",this.releaseArea.bind(this)).on("pointerupoutside",this.releaseArea.bind(this)):this.sprite.on("pointerdown",this.touch.bind(this)).on("pointermove",this.move.bind(this)).on("pointerup",this.release.bind(this)).on("pointerupoutside",this.release.bind(this))},P.prototype.hide=function(){this.sprite.visible=!1},P.prototype.show=function(){this.sprite.visible=!0},P.prototype.touchArea=function(t){null!==this.game.activeObject||this.game.player.lock||(this.game.activeObject=this,this.interaction=t.data,this.action=null,this.touchedPos=this.interaction.getLocalPosition(this.game.app.stage))},P.prototype.releaseArea=function(){if(this.interaction){var t=this.interaction.getLocalPosition(this.game.app.stage);S(t,this.sprite)?this.look():!0===this.door&&(i=this.config.Area,e=t,s=Math.round(e.x),a=Math.round(e.y),o=n.ClosestEdge(i,s,a).point,t={x:Math.round(o.x)+1,y:Math.round(o.y)+1},this.use()),null!==this.action?(this.game.player.tween.once("end",this.action),this.game.player.move(t)):this.cancel(),this.interaction=null,this.touchedPos=null}var i,e,s,a,o},P.prototype.touch=function(t){null!==this.game.activeObject||this.game.player.lock||(this.game.activeObject=this,this.action=null,this.posX=this.sprite.x,this.posY=this.sprite.y,this.interaction=t.data,this.sprite.alpha=.5,this.dragging=!0,this.moved=0,this.oldParent=this.sprite.parent,this.sprite.parentLayer!==this.game.layerUI&&(this.sprite.parentLayer=this.game.layerUI))},P.prototype.move=function(){if(this.dragging){this.moved++,this.sprite.setParent(this.game.app.stage);var t=this.interaction.getLocalPosition(this.sprite.parent),i=this.sprite.getBounds();t.x>i.width/2&&t.x<this.game.width-i.width/2&&(this.sprite.x=t.x),t.y>i.height&&t.y<this.game.height&&(this.sprite.y=t.y)}},P.prototype.release=function(){if(this.interaction){var t={x:this.posX,y:this.posY};S(this.sprite,this.game.inventory.icon)&&this.config.Take?this.take():this.moved<3?this.look():!0===this.config.door?this.use():void 0!==this.config.Use&&(this.game.activePuzzle=this.game.puzzles[this.config.Use],this.use()),null!==this.action?(this.game.player.tween.once("end",this.action),this.game.player.move(t)):this.cancel(),this.sprite.x=this.posX,this.sprite.y=this.posY,this.sprite.alpha=1,this.sprite.parentLayer=this.game.layer,this.sprite.setParent(this.oldParent),this.interaction=null,this.dragging=!1,this.moved=0}},P.prototype.look=function(){this.action=this.game.player.look.bind(this.game.player)},P.prototype.take=function(){this.action=this.game.player.take.bind(this.game.player)},P.prototype.use=function(){this.action=this.game.player.use.bind(this.game.player)},P.prototype.hit=function(){var t,i=null,e=this.game.activeScene.config.Objects;for(t=0;t<e.length;t++)if(S(this.sprite,this.game.objects[e[t]].sprite)&&this.config.Name!==e[t]){i=e[t];break}for(e=this.game.inventory.objects,t=0;t<e.length;t++)if(S(this.sprite,this.game.objects[e[t]].sprite)&&this.config.Name!==e[t]){i=e[t];break}return i},P.prototype.cancel=function(){this.game.activeObject.action=null,this.game.activeObject=null},P.prototype.remove=function(){this.sprite.parent.removeChild(this.sprite)};var T=function(){this.container=new PIXI.Container,this.container.visible=!1,this.game=null,this.objects=[]};T.prototype.build=function(){this.background=new PIXI.Sprite(PIXI.Texture.from(this.game.settings.Inventory.Background)),this.background.width=this.game.width/2,this.background.height=this.game.height/2,this.background.parentLayer=this.game.layerUI,this.container.x=(this.game.width-this.background.width)/2,this.container.y=(this.game.height-this.background.height)/2,this.border=10,this.icon=new PIXI.Sprite(PIXI.Texture.from(this.game.settings.Inventory.Icon)),this.icon.on("pointertap",this.click.bind(this)),this.icon.interactive=!0,this.icon.buttonMode=!0,this.setIcon(this.game.settings.Inventory.Position),this.container.addChild(this.background),this.icon.parentLayer=this.game.layerUI},T.prototype.show=function(){this.update(),this.container.visible=!0},T.prototype.hide=function(){this.container.visible=!1},T.prototype.showIcon=function(){this.icon.visible=!0},T.prototype.hideIcon=function(){this.icon.visible=!1},T.prototype.setIcon=function(t){"bottom-right"==t?(this.icon.x=this.game.width-this.icon.width,this.icon.y=this.game.height-this.icon.height):"top-right"==t?(this.icon.x=this.game.width-this.icon.width,this.icon.y=0):"top-left"==t?(this.icon.x=0,this.icon.y=this.game.height-this.icon.height):"bottom-top"==t&&(this.icon.x=this.game.width-this.icon.width,this.icon.y=0)},T.prototype.click=function(){this.container.visible?this.hide():this.game.player.lock||this.show()},T.prototype.add=function(t){this.objects.push(t),this.game.objects[t].sprite.setParent(this.container),this.game.objects[t].sprite.parentLayer=this.game.layerUI,this.game.objects[t].sprite.on("pointermove",this.move.bind(this.game.objects[t])).off("pointerup").off("pointerupoutside").on("pointerup",this.release.bind(this.game.objects[t])).on("pointerupoutside",this.release.bind(this.game.objects[t])),this.update()},T.prototype.remove=function(t){this.objects.includes(t)&&(this.objects.splice(this.objects.indexOf(t),1),this.update())},T.prototype.update=function(){var t,i=this.objects.length;for(t=0;t<i;t++){var e=this.game.objects[this.objects[t]].sprite;e.width=this.container.width/5-.05*this.container.width,e.height=this.container.height/5-.05*this.container.height,e.x=t%5*this.container.width/5+this.border-t+e.width/2,e.y=Math.floor(t/5)*this.container.height/5+this.border-t+e.height,this.container.width=this.background.width,this.container.height=this.background.height}},T.prototype.move=function(){I(this.sprite,this.game.inventory.container)||this.game.inventory.hide()},T.prototype.release=function(t){if(this.interaction){var i=this.hit(),e={x:this.sprite.x,y:this.sprite.y};this.moved<3?this.game.player.say(this.config.Description[this.game.activeLanguage]):void 0!==this.config.Combine&&null!==i&&(this.config.Combine.With===i&&(this.game.activePuzzle=this.game.puzzles[this.config.Combine.Puzzle]),this.use()),null!==this.action?(this.game.player.tween.once("end",this.action),this.game.player.move(e)):this.cancel(),this.sprite.x=this.posX,this.sprite.y=this.posY,this.sprite.alpha=1,this.sprite.setParent(this.oldParent),this.interaction=null,this.dragging=!1,this.moved=0}};var C=function(){this.solved=!1};C.prototype.resolve=function(){if(null!==this.game.activeObject&&this.game.activeObject.cancel(),this.config.Modify){var t=this.game.objects[this.config.Modify.Name];this.config.Modify.Description&&(t.config.Description=this.config.Modify.Description),this.config.Modify.Door&&this.createDoor(t)}if(this.config.Say&&!this.game.silentMode?this.game.player.say(this.config.Say[this.game.activeLanguage]):this.game.player.stop(),void 0!==this.config.Remove){var i,e=this.config.Remove;for(i=0;i<e.length;i++)this.game.objects[e[i]].remove()}void 0!==this.config.GetObject&&this.game.inventory.add(this.config.GetObject),this.solved=!0,this.game.activePuzzle=null},C.prototype.createDoor=function(t){t.door=!0,t.newScene=this.config.Modify.Door.To,t.playerPos=this.config.Modify.Door.Player},C.prototype.createInventoryObject=function(t){};var k=a.dragonBones.PixiFactory.factory,j=function(){this.game=null,this.state=null,this.lock=!1};j.prototype.setup=function(t){k.parseDragonBonesData(this.game.files.resources[t.Name+"Skeleton"].data),k.parseTextureAtlasData(this.game.files.resources[t.Name+"Json"].data,this.game.files.resources[t.Name+"Tex"].texture),this.sprite=k.buildArmatureDisplay(t.Armature),this.size=1,this.tween=PIXI.tweenManager.createTween(this.sprite),this.tween.on("end",this.stop.bind(this)),this.animations=null!=t.Animations?t.Animations:{Stand:"stand",Walk:"walk",Take:"take",Use:"use",Say:"speak"},this.animate(this.animations.Stand),this.state="stand",this.sprite.x=500,this.sprite.y=500,this.sprite.parentLayer=this.game.layer,this.config=t},j.prototype.hide=function(){this.sprite.visible=!1},j.prototype.show=function(){this.sprite.visible=!0},j.prototype.position=function(t){this.sprite.x=t[0],this.sprite.y=t[1]},j.prototype.move=function(t){var i=t,e=function(t,i,e){var s,a,o=Math.round(t.x),h=Math.round(t.y);if(n.ContainsPoint(e,o,h)){if(void 0!==i)for(var r=0;r<i.length;r++)if(n.ContainsPoint(i[r],o,h)){s=n.ClosestEdge(e,o,h).point,a={x:Math.round(s.x)+1,y:Math.round(s.y)+1};break}}else s=n.ClosestEdge(e,o,h).point,a={x:Math.round(s.x)+1,y:Math.round(s.y)+1};return a}(t,this.game.activeScene.config.Obstacles,this.game.activeScene.config.WalkArea);e&&(i=e);var s=new PIXI.tween.TweenPath,a=this.game.activeScene.walkable.findPath(this.sprite.x,this.sprite.y,i.x,i.y,0);if(a.length>0){this.tween.stop().clear(),this.animate(this.animations.Walk),this.sprite.armature.flipX=!(this.sprite.x<i.x),s.drawShape(new PIXI.Polygon(a)),this.tween.path=s;var o=5*Math.abs(this.sprite.x-i.x)+5*Math.abs(this.sprite.y-i.y)+100*a.length;this.tween.time=o,this.tween.speed=1,this.tween.delay=10,this.tween.start()}},j.prototype.update=function(){PIXI.tweenManager.update(),this.scale()},j.prototype.scale=function(){this.sprite.scale.set(this.sprite.y/this.game.height*this.size)},j.prototype.stop=function(){this.animate(this.animations.Stand),this.game.activeState=null,this.lock=!1},j.prototype.say=function(t){this.game.textField.talker=this,this.game.textField.setText(t),this.game.textField.setColor(Number(this.config.Color)),this.game.textField.show(),this.animate(this.animations.Say),this.timeoutID&&clearTimeout(this.timeoutID),this.timeoutID=setTimeout(this.game.textField.end.bind(this.game.textField),this.game.textField.timeOut())},j.prototype.shutup=function(){this.animate(this.animations.Stand)},j.prototype.animate=function(t,i){this.sprite.animation.lastAnimationName!==t&&this.sprite.animation.fadeIn(t,.25,i)};var O=a.dragonBones.EventObject,M=function(t){function i(){t.apply(this,arguments)}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.move=function(i){t.prototype.move.call(this,i),this.game.activeState=this},i.prototype.say=function(i){t.prototype.say.call(this,i),this.lock=!0},i.prototype.look=function(){null!==this.game.activeObject&&(this.say(this.game.activeObject.config.Description[this.game.activeLanguage]),this.game.activeObject.cancel())},i.prototype.take=function(){this.lock=!0,this.animate(this.animations.Take,1),this.sprite.once(O.COMPLETE,this.takeEnd,this)},i.prototype.takeEnd=function(){if(null!==this.game.activeObject){var t=this.game.activeObject.config.Name;if(null!==this.game.activeScene&&this.game.activeScene.config.Objects.includes(t)){var i=this.game.activeScene.config.Objects.indexOf(t);this.game.activeScene.config.Objects.splice(i,1)}this.game.inventory.add(t),this.game.activeObject.cancel(),this.stop()}},i.prototype.use=function(){this.lock=!0,this.animate(this.animations.Use,1),this.sprite.once(O.COMPLETE,this.useEnd,this)},i.prototype.useEnd=function(){null!==this.game.activePuzzle?this.game.activePuzzle.resolve():null!==this.game.activeObject&&(this.game.activeObject.door?(this.game.setScene(this.game.activeObject.newScene,this.game.activeObject.playerPos),this.stop()):this.say(this.game.data.texts.NotUsable[this.game.activeLanguage]),this.game.activeObject.cancel())},i.prototype.talk=function(){this.game.activeDialogue.start()},i}(j),L=function(t){function i(){t.apply(this,arguments)}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.build=function(){this.sprite.interactive=!0,this.sprite.buttonMode=!0,this.sprite.on("pointerdown",this.touch.bind(this)).on("pointerup",this.release.bind(this)).on("pointerupoutside",this.release.bind(this))},i.prototype.touch=function(t){null!==this.game.activeNPC||this.game.player.lock||(this.game.activeNPC=this,this.action=null,this.interaction=t.data)},i.prototype.release=function(){if(this.interaction){var t={x:this.sprite.x+(this.game.player.sprite.x<this.sprite.x?-1*this.sprite.width:this.sprite.width),y:this.sprite.y};void 0!==this.config.Dialogue&&(this.game.activeDialogue=this.game.dialogues[this.config.Dialogue],this.action=this.game.player.talk.bind(this.game.player)),null!==this.action?(this.game.player.tween.once("end",this.action),this.game.player.move(t)):this.cancel(),this.interaction=null,this.dragging=!1,this.moved=0}},i.prototype.cancel=function(){this.game.activeNPC.action=null,this.game.activeNPC=null},i}(j),z=function(){this.timeoutID=null,this.firstTime=!0,this.choice=null,this.branches={}};z.prototype.setup=function(t){var i;for(this.config=t,length=this.config.Branches.length,i=0;i<length;i++)this.branches[this.config.Branches[i].Name]=this.config.Branches[i];this.currentBranch=this.branches[this.config.DefaultBranch]},z.prototype.start=function(){this.firstTime=!1,this.game.player.lock=!0,this.game.textField.show(),this.game.textField.Choices.get()},z.prototype.next=function(){if(null!==this.choice){var t=this.currentBranch.Choices[this.choice];this.game.textField.Choices.hide(),this.game.player.say(t.Text[this.game.activeLanguage])}else this.game.textField.Choices.get()},z.prototype.searchBranch=function(t){var i,e=-1,s=this.config.Branches.length;for(i=0;i<s;i++)if(this.config.Branches[i].Name==t){e=i;break}return e},z.prototype.answer=function(){var t=this.currentBranch.Choices[this.choice];this.game.activeNPC.say(t.Answer[this.game.activeLanguage]),t.EndDialogue?this.end():t.Link?this.currentBranch=this.branches[t.Link]:t.Puzzle&&(t.Repeat=!1,this.end(),this.game.puzzles[t.Puzzle].resolve()),this.choice=null},z.prototype.end=function(){this.game.activeNPC=null,this.game.activeDialogue=null},z.prototype.timeOut=function(){this.next()};var B=function(t){this.settings={},this.data={},this.width=t.width,this.height=t.height,this.playSounds=!0,this.app=new i.Application(t.width,t.height,{antialias:!0,autoResize:!0,resolution:devicePixelRatio}),this.app.stage=new i.display.Stage,void 0!==t.autoResize?this.app.renderer.autoResize=t.autoResize:window.addEventListener("resize",this.resize.bind(this)),t.parent?document.getElementById(t.parent).appendChild(this.app.view):document.body.appendChild(this.app.view),this.preload(t.files)};B.prototype.preload=function(t){this.progressBar=new i.Graphics,this.progressBar.beginFill(14561865),this.progressBar.drawRect(0,0,this.width,this.height/50),this.progressBar.endFill(),this.progressBar.width=0,this.loadingTxt=new i.Text("Loading...",{fill:"white",fontSize:50}),this.loadingTxt.anchor.set(.5),this.loadingTxt.x=this.width/2,this.loadingTxt.y=this.height/2,this.progressBar.y=this.height/2+this.loadingTxt.height,this.app.stage.addChild(this.loadingTxt),this.app.stage.addChild(this.progressBar),this.jsons=new o,this.jsons.game=this,this.jsons.addJSON(t),this.jsons.load(this.load.bind(this))},B.prototype.load=function(){this.files=new o,this.files.game=this,this.files.addFiles(Object.values(this.jsons.resources)),this.files.load(this.setup.bind(this))},B.prototype.setup=function(){var t;this.app.stage.removeChild(this.loadingTxt),this.app.stage.removeChild(this.progressBar),this.addZOrder(),this.resize(),this.scenes={},this.cutscenes={},this.objects={},this.npcs={},this.dialogues={},this.puzzles={},this.activeLanguage=0,this.activeScene=null,this.activeObject=null,this.activeNPC=null,this.activePuzzle=null,this.activeDialogue=null,this.activeState=null,this.storage=new h(this),this.addScene("Title",new b,this.settings.TitleScreen);var i=this.data.objects.length;for(t=0;t<i;t++)this.addObject(this.data.objects[t].Name,new P,this.data.objects[t]);for(i=this.data.npc.length,t=0;t<i;t++)this.addNPC(this.data.npc[t].Name,new L,this.data.npc[t]);for(i=this.data.dialogues.length,t=0;t<i;t++)this.addDialogue(this.data.dialogues[t].Name,new z,this.data.dialogues[t]);for(i=this.data.scenes.length,t=0;t<i;t++)this.addScene(this.data.scenes[t].Name,new x,this.data.scenes[t]);for(i=this.data.cutscenes.length,t=0;t<i;t++)this.addCutscene(this.data.cutscenes[t].Name,new w,this.data.cutscenes[t]);for(i=this.data.puzzles.length,t=0;t<i;t++)this.addPuzzle(this.data.puzzles[t].Name,new C,this.data.puzzles[t]);this.addInventory(),this.addTextField(),this.addPlayer(),this.storage.check(),this.setScene("Title"),this.app.ticker.add(this.loop.bind(this))},B.prototype.loop=function(t){null!=this.activeState&&this.activeState.update(t)},B.prototype.addObject=function(t,i,e){this.objects[t]=i,i.config=e,i.game=this,i.build()},B.prototype.addScene=function(t,i,e){this.scenes[t]=i,i.setup(e),i.game=this,i.build()},B.prototype.addCutscene=function(t,i,e){this.cutscenes[t]=i,i.config=e,i.game=this,i.build()},B.prototype.addPuzzle=function(t,i,e){this.puzzles[t]=i,i.config=e,i.game=this},B.prototype.setScene=function(t,e){null!==this.activeScene&&this.app.stage.removeChild(this.activeScene.container),this.activeScene=this.scenes[t],this.app.stage.addChild(this.activeScene.container),void 0!==this.activeScene.config.Player&&(void 0!==this.activeScene.config.Player.Position&&this.player.position(this.activeScene.config.Player.Position),void 0!==this.activeScene.config.Player.Size&&(this.player.size=this.activeScene.config.Player.Size,this.player.scale())),void 0!==e&&(this.player.sprite.x=e[0],this.player.sprite.y=e[1]),void 0!==this.activeScene.config.CutScene&&(this.cutscenes[this.activeScene.config.CutScene].played||this.cutscenes[this.activeScene.config.CutScene].show()),this.activeScene!==this.scenes.Title&&this.storage.save(),void 0!==this.activeScene.music&&this.playSounds&&(i.sound.stopAll(),i.sound.exists(this.activeScene.music)&&i.sound.play(this.activeScene.music,{loop:!0}))},B.prototype.addZOrder=function(){this.sortGroup=new i.display.Group(0,!0),this.sortGroup.on("sort",function(t){t.zOrder=-t.y}),this.onTopGroup=new i.display.Group(1,!1),this.UIGroup=new i.display.Group(2,!1),this.layer=new i.display.Layer(this.sortGroup),this.layeronTop=new i.display.Layer(this.onTopGroup),this.layerUI=new i.display.Layer(this.UIGroup),this.app.stage.group.enableSort=!0,this.app.stage.addChild(this.layer),this.app.stage.addChild(this.layeronTop),this.app.stage.addChild(this.layerUI)},B.prototype.addInventory=function(){this.inventory=new T,this.inventory.game=this,this.inventory.build()},B.prototype.addPlayer=function(){this.player=new M,this.player.game=this,this.data.player.Name="player",this.player.setup(this.data.player)},B.prototype.addNPC=function(t,i,e){this.npcs[t]=i,i.game=this,i.setup(e),i.build()},B.prototype.addDialogue=function(t,i,e){this.dialogues[t]=i,i.game=this,i.setup(e)},B.prototype.addTextField=function(){this.textField=new g,this.textField.game=this,this.textField.build()},B.prototype.resize=function(){var t=window.innerWidth*window.devicePixelRatio,i=window.innerHeight*window.devicePixelRatio,e=Math.min(t/this.width,i/this.height);this.app.renderer.resize(this.width*e,this.height*e),this.app.stage.scale.set(e)},B.prototype.start=function(){this.app.stage.addChild(this.inventory.container),this.app.stage.addChild(this.inventory.icon),this.app.stage.addChild(this.player.sprite),this.app.stage.addChild(this.textField.container)},console.log("JSGAM 5.0.0 https://github.com/kreezii/jsgam"),module.exports=B;
//# sourceMappingURL=jsgam.js.map
